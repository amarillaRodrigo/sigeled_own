{"__type":"$$EventMessageWorkflow","id":"ff9dbc54-5171-4632-b1d5-341f112d5bd6","ts":"2025-12-05T00:41:09.586-05:00","eventName":"n8n.workflow.started","message":"n8n.workflow.started","payload":{"executionId":"3","workflowId":"yIL719IyREOoIwrM","isManual":false,"workflowName":"SIGELED-CHAT-ADMIN"}}
{"__type":"$$EventMessageConfirm","confirm":"ff9dbc54-5171-4632-b1d5-341f112d5bd6","ts":"2025-12-05T00:41:09.587-05:00","source":{"id":"0","name":"eventBus"}}
{"__type":"$$EventMessageNode","id":"fa170faf-6fbb-48ce-bf0e-6cb51a3eb10e","ts":"2025-12-05T00:41:09.589-05:00","eventName":"n8n.node.started","message":"n8n.node.started","payload":{"workflowId":"yIL719IyREOoIwrM","workflowName":"SIGELED-CHAT-ADMIN","executionId":"3","nodeType":"n8n-nodes-base.webhook","nodeName":"Webhook","nodeId":"6c20357c-929d-4e58-98e4-d37c046d194e"}}
{"__type":"$$EventMessageConfirm","confirm":"fa170faf-6fbb-48ce-bf0e-6cb51a3eb10e","ts":"2025-12-05T00:41:09.589-05:00","source":{"id":"0","name":"eventBus"}}
{"__type":"$$EventMessageNode","id":"b8e753ea-eadf-4b77-985a-2f1e846b3761","ts":"2025-12-05T00:41:09.592-05:00","eventName":"n8n.node.finished","message":"n8n.node.finished","payload":{"workflowId":"yIL719IyREOoIwrM","workflowName":"SIGELED-CHAT-ADMIN","executionId":"3","nodeType":"n8n-nodes-base.webhook","nodeName":"Webhook","nodeId":"6c20357c-929d-4e58-98e4-d37c046d194e"}}
{"__type":"$$EventMessageConfirm","confirm":"b8e753ea-eadf-4b77-985a-2f1e846b3761","ts":"2025-12-05T00:41:09.592-05:00","source":{"id":"0","name":"eventBus"}}
{"__type":"$$EventMessageNode","id":"5c77847a-dbf3-4f10-9993-1b31f835120b","ts":"2025-12-05T00:41:09.593-05:00","eventName":"n8n.node.started","message":"n8n.node.started","payload":{"workflowId":"yIL719IyREOoIwrM","workflowName":"SIGELED-CHAT-ADMIN","executionId":"3","nodeType":"@n8n/n8n-nodes-langchain.agent","nodeName":"AI Agent","nodeId":"5ba28ffd-4567-4ddc-8aed-7de4ff8462e4"}}
{"__type":"$$EventMessageConfirm","confirm":"5c77847a-dbf3-4f10-9993-1b31f835120b","ts":"2025-12-05T00:41:09.593-05:00","source":{"id":"0","name":"eventBus"}}
{"__type":"$$EventMessageNode","id":"7619ce3a-1c98-4aa7-aa67-4b63f83bd4b1","ts":"2025-12-05T00:41:10.084-05:00","eventName":"n8n.node.started","message":"n8n.node.started","payload":{"workflowId":"yIL719IyREOoIwrM","workflowName":"SIGELED-CHAT-ADMIN","executionId":"3","nodeType":"@n8n/n8n-nodes-langchain.memoryPostgresChat","nodeName":"Postgres Chat Memory","nodeId":"189c4f4b-d14f-4030-a5e6-5f3eadfce175"}}
{"__type":"$$EventMessageConfirm","confirm":"7619ce3a-1c98-4aa7-aa67-4b63f83bd4b1","ts":"2025-12-05T00:41:10.085-05:00","source":{"id":"0","name":"eventBus"}}
{"__type":"$$EventMessageNode","id":"2e5a0b10-8c73-4a03-834a-9c2fe1057c5a","ts":"2025-12-05T00:41:12.259-05:00","eventName":"n8n.node.finished","message":"n8n.node.finished","payload":{"workflowId":"yIL719IyREOoIwrM","workflowName":"SIGELED-CHAT-ADMIN","executionId":"3","nodeType":"@n8n/n8n-nodes-langchain.memoryPostgresChat","nodeName":"Postgres Chat Memory","nodeId":"189c4f4b-d14f-4030-a5e6-5f3eadfce175"}}
{"__type":"$$EventMessageConfirm","confirm":"2e5a0b10-8c73-4a03-834a-9c2fe1057c5a","ts":"2025-12-05T00:41:12.260-05:00","source":{"id":"0","name":"eventBus"}}
{"__type":"$$EventMessageNode","id":"b4d67512-feda-4dde-b0d9-80561ade3ff9","ts":"2025-12-05T00:41:14.138-05:00","eventName":"n8n.node.started","message":"n8n.node.started","payload":{"workflowId":"yIL719IyREOoIwrM","workflowName":"SIGELED-CHAT-ADMIN","executionId":"3","nodeType":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","nodeName":"Google Gemini Chat Model","nodeId":"a4f65c9a-711c-43b6-9933-63c6295de3c3"}}
{"__type":"$$EventMessageConfirm","confirm":"b4d67512-feda-4dde-b0d9-80561ade3ff9","ts":"2025-12-05T00:41:14.138-05:00","source":{"id":"0","name":"eventBus"}}
{"__type":"$$EventMessageNode","id":"b483e258-2207-4e5b-99b3-958cb6693ecc","ts":"2025-12-05T00:41:16.402-05:00","eventName":"n8n.node.finished","message":"n8n.node.finished","payload":{"workflowId":"yIL719IyREOoIwrM","workflowName":"SIGELED-CHAT-ADMIN","executionId":"3","nodeType":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","nodeName":"Google Gemini Chat Model","nodeId":"a4f65c9a-711c-43b6-9933-63c6295de3c3"}}
{"__type":"$$EventMessageConfirm","confirm":"b483e258-2207-4e5b-99b3-958cb6693ecc","ts":"2025-12-05T00:41:16.403-05:00","source":{"id":"0","name":"eventBus"}}
{"__type":"$$EventMessageAiNode","id":"b68eed85-f9c4-42c1-9315-912abc094254","ts":"2025-12-05T00:41:16.406-05:00","eventName":"n8n.ai.llm.generated","message":"n8n.ai.llm.generated","payload":{"executionId":"3","nodeName":"Google Gemini Chat Model","workflowName":"SIGELED-CHAT-ADMIN","nodeType":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","workflowId":"yIL719IyREOoIwrM","msg":"{\"messages\":[\"System: IDENTIDAD Y CONTEXTO\\n\\nEres Clampy, el Asistente de Inteligencia Artificial de SIGELED, el sistema de gestión de legajos, contratos y recursos humanos del IPF.\\n\\n-Misión: Democratizar el acceso a la información de la base de datos para el personal del IPF (RRHH, Administrativos, Coordinadores, Directivos).\\n-Tono: Profesional, cálido, paciente y resolutivo.\\n-Idioma: SIEMPRE respondes en Español, incluso si la pregunta viene en otro idioma.\\n-Capacidad: Tienes acceso de solo lectura a una base de datos PostgreSQL mediante la herramienta consultar_base_datos (o un nodo intermedio que ejecuta SQL que tú generas).\\n\\nREGLAS NÚCLEO (OBLIGATORIAS)\\n\\n-SQL obligatorio para datos concretos:\\nSiempre que el usuario pida datos reales (listados, montos, fechas, estados, conteos, etc.), DEBES generar y ejecutar una consulta SQL usando consultar_base_datos.\\n\\nEjemplos de datos concretos:\\n-“listado de usuarios”\\n-“cuánto cobra”\\n-“estado de legajo”\\n-“documentos que tiene”\\n-“materias que dicta”\\n\\nSolo puedes responder sin SQL en:\\n-Definiciones y explicaciones generales (ej. “¿Qué es un legajo?”).\\n-Preguntas de uso del sistema que no requieren leer datos (ej. “¿Qué hace el módulo de contratos?”).\\n-Saludos y charla básica.\\n\\n-Solo lectura:\\n-Tus consultas SIEMPRE deben empezar con SELECT.\\n-Está PROHIBIDO usar INSERT, UPDATE, DELETE, DROP, ALTER u otras operaciones de escritura.\\n\\n-Privacidad y campos sensibles:\\n-Jamás selecciones ni muestres la columna password_hash de la tabla usuarios.\\n-Evita mostrar información altamente sensible innecesaria (ej. CUIL/DNI de terceros) salvo que el usuario lo pida explícitamente y tenga sentido en contexto (por ejemplo, RRHH consultando legajos).\\n-Si el flujo no indica el rol del usuario, asume que es personal interno del IPF pero no inventes restricciones adicionales: limita tu respuesta a lo que se te pida y a lo estrictamente necesario.\\n\\n-Cero alucinaciones de datos:\\n-Está terminantemente prohibido inventar correos, nombres, contratos, documentos o cualquier fila que no salga de la base.\\n-Si la consulta SQL devuelve 0 filas, responde literalmente:\\n\\\"No se encontraron registros que coincidan con tu búsqueda.\\\"\\n-Si por alguna razón no puedes ejecutar SQL (por ejemplo, error técnico, nodo desconectado), dilo claramente:\\n\\\"En este momento no puedo acceder a la base de datos, por lo que no puedo traerte datos reales. Inténtalo de nuevo más tarde o contacta a soporte.\\\"\\n\\n-Manejo de errores SQL:\\n-Si la consulta falla (columna mal escrita, tabla mal nombrada, etc.), no le muestres el error crudo al usuario.\\n-Ajusta internamente la consulta (corrige nombres de tablas/columnas) y vuelve a intentar.\\n-Solo si no logras corregirla, responde:\\n\\\"Ocurrió un error al consultar la base de datos. Por favor, revisa los criterios o intenta de nuevo más tarde.\\\"\\n\\n-Idioma consistente:\\n-Tus respuestas al usuario son SIEMPRE en español.\\n-Puedes escribir SQL con palabras clave en inglés (SELECT, WHERE…) pero no escribas explicaciones ni textos en inglés al usuario.\\n\\n-Formato de llamada a la base de datos (para n8n):\\n-Cuando el flujo requiera que generes una consulta para consultar_base_datos, devuelve solo la consulta SQL, sin explicaciones, sin texto adicional y sin bloques markdown.\\n-Luego, cuando tengas el resultado de la base, en el siguiente mensaje al usuario formateas la respuesta de forma amigable en español, sin mostrar la consulta SQL.\\n\\nMAPA MENTAL DE LA BASE (TABLAS Y RELACIONES)\\n\\nUsa exclusivamente estos nombres de tablas y columnas. Respeta mayúsculas/minúsculas según el esquema real. No inventes nombres ni columnas que no existan.\\n\\n3.1. Módulo de Identidad y Usuarios\\n\\n-usuarios – Cuentas de acceso al sistema\\n\\nColumnas clave:\\n-id_usuario (PK)\\n-email\\n-password_hash (NO mostrar nunca)\\n-activo (boolean)\\n-fecha_creacion\\n-ultimo_login\\n-id_persona (FK a personas.id_persona)\\n\\nRegla típica:\\n-Para usuarios activos usar: WHERE u.activo = true.\\n\\n-personas – Datos personales de la persona real\\n\\nColumnas clave:\\n-id_persona (PK)\\n-nombre\\n-apellido\\n-fecha_nacimiento\\n-sexo\\n-telefono\\n\\nRelación principal:\\n-usuarios.id_persona = personas.id_persona\\n\\n-persona_identificacion – DNI y CUIL de la persona\\n\\nColumnas clave:\\n-id_persona (FK a personas)\\n-dni\\n-cuil\\n\\nUso típico para completar datos de identificación:\\n\\nSELECT p.nombre, p.apellido, pi.dni, pi.cuil\\nFROM personas p\\nLEFT JOIN persona_identificacion pi ON p.id_persona = pi.id_persona\\nWHERE p.apellido ILIKE '%Quiroga%';\\n\\n3.2. Domicilio y Barrio\\n\\n-dom_barrio – Catálogo de barrios y detalles\\n\\nColumnas:\\n-id_dom_barrio\\n-barrio\\n-manzana\\n-casa\\n-departamento\\n-piso\\n-id_dom_localidad (no detallado aquí, pero puede existir una tabla de localidades)\\n\\n-persona_barrio – Relación persona–barrio principal\\n\\nColumnas:\\n-id_persona (FK personas)\\n-id_dom_barrio (FK dom_barrio)\\n-created_at\\n\\n-persona_domicilio – Domicilio más detallado\\n\\nColumnas:\\n-id_domicilio\\n-calle\\n-altura\\n-id_dom_barrio (FK dom_barrio)\\n-id_persona (FK personas)\\n\\nPatrón de JOIN para mostrar domicilio completo:\\n\\nSELECT p.nombre, p.apellido,\\nd.calle, d.altura,\\nb.barrio, b.manzana, b.casa, b.departamento, b.piso\\nFROM personas p\\nLEFT JOIN persona_domicilio d ON p.id_persona = d.id_persona\\nLEFT JOIN dom_barrio b ON d.id_dom_barrio = b.id_dom_barrio\\nWHERE p.apellido ILIKE '%Quiroga%';\\n\\n3.3. Roles del Sistema vs Perfiles/Cargos\\n\\n-roles – Roles de acceso al software\\n\\nColumnas:\\n-id_rol\\n-codigo\\n-nombre\\nEjemplos de codigo: ADMIN, RRHH, ADMTVO, EMP\\n\\n-usuarios_roles – Roles asignados a cada usuario\\n\\nColumnas:\\n-id_usuario (FK usuarios)\\n-id_rol (FK roles)\\n-asignado_por\\n-asignado_en\\n\\nUso:\\n-Saber qué permisos tiene un usuario en SIGELED.\\n\\n-perfiles – Perfiles laborales/académicos\\n\\nColumnas:\\n-id_perfil\\n-codigo (ej. PROF, COOR, ADMITVO, RRHH, INVEST)\\n-nombre\\n\\n-personas_perfiles – Perfiles asignados a una persona\\n\\nColumnas:\\n-id_persona (FK personas)\\n-id_perfil (FK perfiles)\\n-vigente (boolean)\\n-fecha_inicio\\n-fecha_fin\\n-asignado_por_usuario\\n-asignado_en\\n-actualizado_por_usuario\\n-actualizado_en\\n\\nRegla:\\n-Usar solo perfiles vigentes salvo que se pidan históricos:\\nWHERE pp.vigente = true\\n\\nPatrón típico:\\n\\nSELECT p.nombre, p.apellido, pe.codigo AS codigo_perfil, pe.nombre AS nombre_perfil\\nFROM personas p\\nJOIN personas_perfiles pp ON p.id_persona = pp.id_persona\\nJOIN perfiles pe ON pp.id_perfil = pe.id_perfil\\nWHERE pp.vigente = true;\\n\\nMÓDULO DE LEGAJO, DOCUMENTOS Y TÍTULOS\\n\\nEste módulo responde cosas como:\\n-“¿Qué documentos ya subió X?”\\n-“¿Qué títulos tiene y en qué estado están?”\\n-“¿Por qué me rechazaron el DNI o un título?”\\n-“¿Cómo está el estado global de mi legajo?”\\n\\n4.1. Catálogos / Diccionarios\\n\\n-estado_verificacion – Estados de verificación de documentos/títulos\\n\\nColumnas:\\n-id_estado\\n-codigo\\n-nombre\\nEjemplos de codigo: PENDIENTE, APROBADO, RECHAZADO, OBSERVADO\\n\\n-tipos_documento – Tipos de documentos aceptados\\n\\nColumnas:\\n-id_tipo_doc\\n-codigo\\n-nombre\\n-obligatorio (boolean)\\nEjemplos de codigo: DNI, CUIL, DOM, TIT, CV, CON_SER\\n\\n-tipos_titulo – Tipos de título aceptados\\n\\nColumnas:\\n-id_tipo_titulo\\n-codigo\\n-nombre\\nEjemplos: TEC_SUP, PROF, LIC, POS\\n\\n-estados_legajo – Estado global del legajo\\n\\nColumnas:\\n-id_estado\\n-codigo\\n-nombre\\nEjemplos: INCOMPLETO, PENDIENTE, VALIDADO, BLOQUEADO\\n\\n4.2. Documentos y Títulos de la Persona\\n\\n-personas_documentos – Documentos cargados por la persona\\n\\nColumnas:\\n-id_persona_doc\\n-id_persona (FK personas)\\n-id_tipo_doc (FK tipos_documento)\\n-id_archivo (FK archivos)\\n-id_estado_verificacion (FK estado_verificacion)\\n-vigente (boolean)\\n-creado_en\\n\\n-verificacion_documentos – Auditoría de verificación de documentos\\n\\nColumnas:\\n-id_verificacion\\n-id_persona_doc (FK personas_documentos)\\n-id_estado_verificacion (FK estado_verificacion)\\n-observacion\\n-verificado_por_usuario (FK usuarios)\\n-verificado_en\\n\\n-personas_titulos – Títulos académicos de la persona\\n\\nColumnas:\\n-id_titulo\\n-id_persona\\n-id_tipo_titulo (FK tipos_titulo)\\n-nombre_titulo\\n-institucion\\n-fecha_emision\\n-matricula_prof\\n-id_archivo (FK archivos)\\n-id_estado_verificacion (FK estado_verificacion)\\n-verificado_por_usuario\\n-verificado_en\\n-creado_en\\n\\n-verificacion_titulos – Auditoría de verificación de títulos\\n\\nColumnas:\\n-id_verificacion\\n-id_titulo (FK personas_titulos)\\n-id_estado_verificacion\\n-observacion\\n-verificado_por_usuario\\n-verificado_en\\n\\n-personas_legajo_estado – Estado actual del legajo\\n\\nColumnas:\\n-id_persona\\n-id_estado_legajo (FK estados_legajo)\\n-actualizado_en\\n-actualizado_por_usuario\\n\\n-personas_legajo_historial – Historial de cambios del legajo\\n\\nColumnas:\\n-id_hist\\n-id_persona\\n-id_estado_legajo (FK estados_legajo)\\n-motivo\\n-cambiado_por_usuario\\n-cambiado_en\\n\\n-archivos – Metadatos de cualquier archivo\\n\\nColumnas:\\n-id_archivo\\n-nombre_original\\n-content_type\\n-size_bytes\\n-sha256_hex\\n-storage_provider\\n-storage_bucket\\n-storage_key\\n-subido_por_usuario\\n-subido_en\\n\\nConversión de tamaño:\\n-MB = size_bytes / 1048576.0 (muestra con 2 decimales).\\n\\nPatrones típicos:\\n\\n-Documentos de una persona con estado legible y tipo de documento:\\n\\nSELECT td.nombre AS tipo_documento,\\nd.vigente,\\nev.nombre AS estado_verificacion,\\na.nombre_original,\\na.size_bytes,\\nd.creado_en\\nFROM personas_documentos d\\nJOIN tipos_documento td ON d.id_tipo_doc = td.id_tipo_doc\\nJOIN estado_verificacion ev ON d.id_estado_verificacion = ev.id_estado\\nLEFT JOIN archivos a ON d.id_archivo = a.id_archivo\\nWHERE d.id_persona = $ID_PERSONA\\nORDER BY d.creado_en DESC;\\n\\n-Títulos rechazados u observados, con motivo:\\n\\nSELECT pt.nombre_titulo,\\ntt.nombre AS tipo_titulo,\\nev.nombre AS estado_verificacion,\\nvt.observacion,\\nvt.verificado_en\\nFROM personas_titulos pt\\nJOIN tipos_titulo tt ON pt.id_tipo_titulo = tt.id_tipo_titulo\\nJOIN estado_verificacion ev ON pt.id_estado_verificacion = ev.id_estado\\nLEFT JOIN verificacion_titulos vt ON pt.id_titulo = vt.id_titulo\\nWHERE pt.id_persona = $ID_PERSONA\\nAND ev.codigo IN ('RECHAZADO', 'OBSERVADO');\\n\\n-Estado global del legajo:\\n\\nSELECT el.codigo, el.nombre, ple.actualizado_en\\nFROM personas_legajo_estado ple\\nJOIN estados_legajo el ON ple.id_estado_legajo = el.id_estado\\nWHERE ple.id_persona = $ID_PERSONA;\\n\\n-Historial del legajo:\\n\\nSELECT h.cambiado_en, el.nombre AS estado, h.motivo\\nFROM personas_legajo_historial h\\nJOIN estados_legajo el ON h.id_estado_legajo = el.id_estado\\nWHERE h.id_persona = $ID_PERSONA\\nORDER BY h.cambiado_en DESC;\\n\\nMÓDULO DE CONTRATOS, CARGOS Y TARIFAS\\n\\nEste módulo responde cosas como:\\n-“¿Cuántos contratos vigentes tiene X?”\\n-“¿Cuánto cobra por mes?”\\n-“¿Qué materias dicta y en qué carrera?”\\n-“¿Qué cargos de coordinación/administrativo tiene?”\\n\\n5.1. Periodos y académicos base\\n\\n-periodo\\n\\nColumnas:\\n-id_periodo\\n-descripcion (ej. “Marzo a Julio”, “Agosto a diciembre”)\\n\\n-anio\\n\\nColumnas:\\n-id_anio\\n-descripcion (Primer Año, Segundo Año, etc.)\\n-createdAt\\n-updatedAt\\n\\n-carrera\\n\\nColumnas:\\n-id_carrera\\n-carrera_descripcion\\n-createdAt\\n-updatedAt\\n\\n-materia\\n\\nColumnas:\\n-id_materia\\n-descripcion_materia\\n-id_anio (FK anio)\\n-createdAt\\n-updatedAt\\n\\n-materia_carrera\\n\\nColumnas:\\n-id_materia_carrera\\n-id_materia (FK materia)\\n-id_carrera (FK carrera)\\n\\n-profesor\\n\\nColumnas:\\n-id_profesor\\n-id_persona (FK personas)\\n-id_cargo_materia (nullable u otros campos)\\n-createdAt\\n-updatedAt\\n\\n5.2. Modelo moderno de contratos\\n\\n-contrato – Cabecera del contrato\\n\\nColumnas:\\n-id_contrato\\n-id_persona\\n-id_periodo\\n-fecha_inicio\\n-fecha_fin\\n-horas_semanales\\n-horas_mensuales\\n-monto_hora_promedio\\n-total_importe_mensual\\n-external_id\\n-created_at\\n-updated_at\\n\\nContrato vigente:\\n-WHERE current_date BETWEEN c.fecha_inicio AND COALESCE(c.fecha_fin, 'infinity')\\n\\n-contrato_item – Ítems/cargos dentro del contrato\\n\\nColumnas:\\n-id_contrato_item\\n-id_contrato (FK contrato)\\n-id_perfil (FK perfiles)\\n-tipo_item (ej: DOCENCIA, COORDINACION, ADMINISTRATIVO, INVESTIGACION, etc.)\\n-id_materia (nullable, FK materia)\\n-descripcion_actividad\\n-codigo_cargo (ej. TITULAR, JTP, AUXILIAR, COORDINADOR_CARRERA)\\n-horas_semanales\\n-monto_hora\\n-subtotal_mensual\\n\\n-perfil_tarifa – Tabla de referencia de montos fijos por perfil-cargo\\n\\nColumnas:\\n-id_tarifa\\n-id_perfil (FK perfiles)\\n-codigo_cargo\\n-descripcion\\n-aplica_materias (boolean)\\n-monto_hora\\n-activo (boolean)\\n\\nUso típico:\\n-Sugerir o validar monto_hora base según perfil/cargo.\\n\\nPatrones típicos:\\n\\n-Contratos vigentes de una persona y total que cobra por mes:\\n\\nSELECT SUM(c.total_importe_mensual) AS total_mensual\\nFROM contrato c\\nWHERE c.id_persona = $ID_PERSONA\\nAND current_date BETWEEN c.fecha_inicio AND COALESCE(c.fecha_fin, 'infinity');\\n\\n-Detalle de ítems (materias y cargos no docentes):\\n\\nSELECT ci.tipo_item,\\nci.codigo_cargo,\\nci.horas_semanales,\\nci.monto_hora,\\nci.subtotal_mensual,\\nm.descripcion_materia,\\ncar.carrera_descripcion\\nFROM contrato_item ci\\nLEFT JOIN materia m ON ci.id_materia = m.id_materia\\nLEFT JOIN materia_carrera mc ON m.id_materia = mc.id_materia\\nLEFT JOIN carrera car ON mc.id_carrera = car.id_carrera\\nWHERE ci.id_contrato = $ID_CONTRATO;\\n\\n-Contratos y cargos de coordinación / administrativos de una persona:\\n\\nSELECT c.id_contrato,\\np.codigo AS codigo_perfil,\\np.nombre AS nombre_perfil,\\nci.tipo_item,\\nci.codigo_cargo,\\nci.descripcion_actividad,\\nci.horas_semanales,\\nci.monto_hora,\\nci.subtotal_mensual\\nFROM contrato c\\nJOIN contrato_item ci ON c.id_contrato = ci.id_contrato\\nJOIN perfiles p ON ci.id_perfil = p.id_perfil\\nWHERE c.id_persona = $ID_PERSONA\\nAND ci.tipo_item <> 'DOCENCIA';\\n\\n5.3. Modelo legado de contratos de profesor (si aplica)\\n\\n-Solo usar estas tablas si se te pide explícitamente “contrato_profesor” o si existe lógica legacy en el sistema.\\n\\n-contrato_profesor\\n\\nColumnas principales:\\n-id_contrato_profesor\\n-id_persona\\n-id_profesor\\n-horas_semanales\\n-horas_mensuales\\n-fecha_inicio\\n-fecha_fin\\n-id_periodo\\n-id_materia\\n-monto_hora\\n-external_id\\n-createdAt\\n-updatedAt\\n\\n-contrato_profesor_materia\\n\\nColumnas:\\n-id_cpm\\n-id_contrato_profesor\\n-id_materia\\n-horas_semanales\\n-cargo\\n-monto_hora\\n\\nPatrón para consultar contratos de profesor:\\n\\nSELECT cp.id_contrato_profesor,\\ncp.horas_semanales,\\ncp.horas_mensuales,\\ncp.fecha_inicio,\\ncp.fecha_fin,\\nm.descripcion_materia,\\nc.carrera_descripcion\\nFROM contrato_profesor cp\\nLEFT JOIN contrato_profesor_materia cpm ON cp.id_contrato_profesor = cpm.id_contrato_profesor\\nLEFT JOIN materia m ON cpm.id_materia = m.id_materia\\nLEFT JOIN materia_carrera mc ON m.id_materia = mc.id_materia\\nLEFT JOIN carrera c ON mc.id_carrera = c.id_carrera\\nWHERE cp.id_persona = $ID_PERSONA;\\n\\nESTRATEGIAS DE RAZONAMIENTO Y DESAMBIGUACIÓN\\n\\n6.1. Personas con nombre repetido\\n\\n-Si el usuario dice: “¿Quién es Juan?” o “Dame los datos de Juan Quiroga”:\\n\\n-Paso 1: Buscar en personas por nombre y/o apellido con ILIKE.\\n-Paso 2: Si hay más de una coincidencia, mostrar una tabla con varias columnas para que el usuario elija.\\n\\nEjemplo de consulta:\\n\\nSELECT p.id_persona,\\np.apellido,\\np.nombre,\\npi.dni,\\nu.email\\nFROM personas p\\nLEFT JOIN persona_identificacion pi ON p.id_persona = pi.id_persona\\nLEFT JOIN usuarios u ON p.id_persona = u.id_persona\\nWHERE p.nombre ILIKE '%Juan%' AND p.apellido ILIKE '%Quiroga%';\\n\\nRespuesta:\\n-Si hay varios resultados: “Encontré varias personas, por favor indicá cuál te interesa” (y mostrar tabla).\\n-Si hay una sola persona: puedes directamente usar su id_persona para posteriores consultas (contratos, legajo, etc.).\\n\\n6.2. “Yo”, “mi legajo”, “mis contratos”\\n\\n-Si el contexto del flujo te pasa el id_persona del usuario autenticado y la pregunta es:\\n-“¿Cómo está mi legajo?”\\n-“¿Qué documentos me faltan?”\\n-“¿Qué materias estoy dando?”\\n\\nEntonces:\\n-Utiliza exclusivamente ese id_persona en las consultas.\\n-No preguntes de nuevo el nombre si ya tenés el id_persona.\\n\\n6.3. Preguntas ambiguas tipo “Dame los datos”\\n\\n-Si el usuario dice algo genérico como:\\n-“Dame los datos”\\n-“Mostrame la info”\\n-“Pasame los detalles de esa persona”\\n\\nDebes pedir precisión:\\n\\n-“¿A qué datos te referís? Puedo mostrarte datos personales, domicilio, roles del sistema, perfiles laborales, estado de legajo, documentos, títulos o contratos. Indicame qué persona y qué tipo de información necesitás.”\\n\\n-No ejecutes SQL hasta que haya un criterio mínimamente claro (persona, área, tipo de información, etc.).\\n\\n6.4. Pedidos de listados masivos\\n\\n-Si te piden:\\n-“Listame todos los usuarios registrados”\\n-“Dame todos los contratos del sistema”\\n-“Mostrá todos los legajos”\\n\\nReglas:\\n-Usa siempre un LIMIT razonable (por ejemplo 50 o 100) si no se especifica filtro.\\n-Explica que estás limitando los resultados, por ejemplo:\\n-“Te muestro los primeros 50 registros. Si querés, luego lo filtramos por apellido, estado, periodo, etc.”\\n\\nEjemplo para usuarios:\\n\\nSELECT u.email, p.nombre, p.apellido\\nFROM usuarios u\\nLEFT JOIN personas p ON u.id_persona = p.id_persona\\nORDER BY p.apellido, p.nombre\\nLIMIT 50;\\n\\n6.5. Confusión entre rol y perfil\\n\\n-Si el usuario pregunta:\\n-“¿Qué rol tiene en el sistema?”\\n→ usar tablas roles y usuarios_roles.\\n\\n-Si el usuario pregunta:\\n-“¿Qué cargo tiene?” o “¿Qué función cumple?”\\n→ usar perfiles y personas_perfiles, o bien contrato_item (tipo_item, codigo_cargo) para cargos dentro de contratos.\\n\\n-Si la pregunta mezcla conceptos (“¿qué rol/cargo tiene en el sistema?”), puedes devolver ambos pero explicando la diferencia:\\n-“A nivel sistema (roles): ADMIN / RRHH / EMP.\\nA nivel laboral (perfiles/cargos): PROF, COOR, ADMITVO, etc.”\\n\\nFORMATO DE RESPUESTA AL USUARIO\\n\\n-Tablas Markdown:\\n-Cuando devuelvas listados de más de 1 fila, usa tablas en formato Markdown. Ejemplo:\\n\\nApellido y Nombre\\tDNI\\tEmail\\tEstado Legajo\\nQuiroga, Juan\\t45956451\\tjuanqi3489@gmail.com\\n\\tValidado\\n\\n-Negritas para datos clave:\\n-Resalta en negrita (usando markdown) datos relevantes como:\\n-Estados (Validado, Rechazado, Pendiente, etc.)\\n-Montos en dinero: $ 104000.00\\n-Fechas importantes.\\n\\n-Fechas legibles en español:\\n-Convierte YYYY-MM-DD a un formato entendible, por ejemplo:\\n-25/10/2004 o “25 de Octubre de 2004”.\\n-Sé consistente dentro de la misma respuesta.\\n\\n-Límites y aviso de truncado:\\n-Si traes más de 20 registros, muestra solo los primeros 20 y agrega una frase como:\\n-“Mostrando 20 de N resultados. Podemos filtrar por apellido, periodo, estado, etc. si lo necesitás.”\\n\\n-Respuestas cuando no hay datos:\\n-Usa SIEMPRE:\\n-“No se encontraron registros que coincidan con tu búsqueda.”\\n-No inventes un listado de ejemplo bajo ninguna circunstancia.\\n\\nEJEMPLOS DE CASOS DE USO (GUÍA INTERNA)\\n\\n-Estos ejemplos son guía interna, no los muestres tal cual al usuario. Úsalos para diseñar tus consultas SQL y el tipo de respuesta.\\n\\n-Caso A – Listado de usuarios registrados (email, nombre, apellido)\\n\\nUsuario:\\n-“Me podrías hacer un listado de los usuarios que están registrados? Incluyendo su email, nombre y apellido.”\\n\\nPensamiento:\\n-“Debo leer de usuarios y unir con personas. No puedo inventar nombres ni emails. Debo limitar la cantidad.”\\n\\nSQL:\\n\\nSELECT u.email,\\np.nombre,\\np.apellido\\nFROM usuarios u\\nLEFT JOIN personas p ON u.id_persona = p.id_persona\\nWHERE u.activo = true\\nORDER BY p.apellido, p.nombre\\nLIMIT 50;\\n\\nRespuesta al usuario:\\n-Usar los resultados reales de la consulta y formatearlos en tabla Markdown.\\n\\n-Caso B – “¿Por qué rechazaron mi título?”\\n\\nTablas clave:\\n-personas_titulos\\n-estado_verificacion\\n-verificacion_titulos\\n\\nSQL orientativo:\\n\\nSELECT pt.nombre_titulo,\\nev.nombre AS estado,\\nvt.observacion,\\nvt.verificado_en\\nFROM personas_titulos pt\\nJOIN estado_verificacion ev ON pt.id_estado_verificacion = ev.id_estado\\nLEFT JOIN verificacion_titulos vt ON pt.id_titulo = vt.id_titulo\\nWHERE pt.id_persona = $ID_PERSONA\\nAND ev.codigo = 'RECHAZADO';\\n\\n-Caso C – “¿Cuánto cobra X por mes actualmente?”\\n\\nUsar contratos vigentes en tabla contrato:\\n\\nSELECT SUM(c.total_importe_mensual) AS total_mensual\\nFROM contrato c\\nJOIN personas p ON c.id_persona = p.id_persona\\nWHERE p.apellido ILIKE '%Valdez%'\\nAND current_date BETWEEN c.fecha_inicio AND COALESCE(c.fecha_fin, 'infinity');\\n\\n-Caso D – “¿Qué materias dicta el profesor Quiroga y en qué carreras?”\\n\\nUsar contrato + contrato_item + materia + materia_carrera + carrera:\\n\\nSELECT m.descripcion_materia,\\na.descripcion AS anio,\\nc.carrera_descripcion,\\nci.horas_semanales,\\nper.nombre AS perfil_descripcion,\\nci.codigo_cargo\\nFROM contrato co\\nJOIN personas p ON co.id_persona = p.id_persona\\nJOIN contrato_item ci ON co.id_contrato = ci.id_contrato\\nLEFT JOIN materia m ON ci.id_materia = m.id_materia\\nLEFT JOIN anio a ON m.id_anio = a.id_anio\\nLEFT JOIN materia_carrera mc ON m.id_materia = mc.id_materia\\nLEFT JOIN carrera c ON mc.id_carrera = c.id_carrera\\nLEFT JOIN perfiles per ON ci.id_perfil = per.id_perfil\\nWHERE p.apellido ILIKE '%Quiroga%'\\nAND ci.tipo_item = 'DOCENCIA';\\n\\nCOMPORTAMIENTO FINAL\\n\\n-Siempre:\\n-Pregunta cuando falte contexto o la consulta sea ambigua.\\n-Usa SQL para datos concretos que dependan de la base.\\n-No inventes filas, correos, nombres, contratos ni documentos de ejemplo.\\n-Responde en un español claro, adaptado a personal administrativo/RRHH.\\n-Mantén la coherencia con el modelo de datos anterior y sus relaciones.\\n\\n-Si en algún momento te ves tentado a responder con datos inventados, detente y recuerda:\\n\\n-\\\"Si no sale de la base de datos, no lo digo.\\\"\\nHuman: hola como estas\"],\"options\":{\"google_api_key\":{\"lc\":1,\"type\":\"secret\",\"id\":[\"GOOGLE_API_KEY\"]},\"base_url\":\"https://generativelanguage.googleapis.com\",\"model\":\"gemini-2.5-flash-lite\"},\"response\":{\"response\":{\"generations\":[[{\"text\":\"¡Hola! Estoy muy bien, gracias por preguntar. ¿En qué puedo ayudarte hoy?\",\"generationInfo\":{\"finishReason\":\"STOP\",\"index\":0}}]]},\"tokenUsage\":{\"completionTokens\":18,\"promptTokens\":7440,\"totalTokens\":7458}}}"}}
{"__type":"$$EventMessageConfirm","confirm":"b68eed85-f9c4-42c1-9315-912abc094254","ts":"2025-12-05T00:41:16.407-05:00","source":{"id":"0","name":"eventBus"}}
{"__type":"$$EventMessageNode","id":"800b92fe-c40b-4b09-9082-71193e2d36a7","ts":"2025-12-05T00:41:16.416-05:00","eventName":"n8n.node.started","message":"n8n.node.started","payload":{"workflowId":"yIL719IyREOoIwrM","workflowName":"SIGELED-CHAT-ADMIN","executionId":"3","nodeType":"@n8n/n8n-nodes-langchain.memoryPostgresChat","nodeName":"Postgres Chat Memory","nodeId":"189c4f4b-d14f-4030-a5e6-5f3eadfce175"}}
{"__type":"$$EventMessageConfirm","confirm":"800b92fe-c40b-4b09-9082-71193e2d36a7","ts":"2025-12-05T00:41:16.416-05:00","source":{"id":"0","name":"eventBus"}}
{"__type":"$$EventMessageNode","id":"21cd9f67-a5b1-4960-bb5e-33eedae6a84a","ts":"2025-12-05T00:41:17.278-05:00","eventName":"n8n.node.finished","message":"n8n.node.finished","payload":{"workflowId":"yIL719IyREOoIwrM","workflowName":"SIGELED-CHAT-ADMIN","executionId":"3","nodeType":"@n8n/n8n-nodes-langchain.memoryPostgresChat","nodeName":"Postgres Chat Memory","nodeId":"189c4f4b-d14f-4030-a5e6-5f3eadfce175"}}
{"__type":"$$EventMessageConfirm","confirm":"21cd9f67-a5b1-4960-bb5e-33eedae6a84a","ts":"2025-12-05T00:41:17.278-05:00","source":{"id":"0","name":"eventBus"}}
{"__type":"$$EventMessageNode","id":"ed8957d0-d8d1-4958-9398-a56a2da943f8","ts":"2025-12-05T00:41:17.360-05:00","eventName":"n8n.node.finished","message":"n8n.node.finished","payload":{"workflowId":"yIL719IyREOoIwrM","workflowName":"SIGELED-CHAT-ADMIN","executionId":"3","nodeType":"@n8n/n8n-nodes-langchain.agent","nodeName":"AI Agent","nodeId":"5ba28ffd-4567-4ddc-8aed-7de4ff8462e4"}}
{"__type":"$$EventMessageConfirm","confirm":"ed8957d0-d8d1-4958-9398-a56a2da943f8","ts":"2025-12-05T00:41:17.360-05:00","source":{"id":"0","name":"eventBus"}}
{"__type":"$$EventMessageWorkflow","id":"7ec7b9bb-03dd-41db-84f7-6b87bb49b60c","ts":"2025-12-05T00:41:17.366-05:00","eventName":"n8n.workflow.success","message":"n8n.workflow.success","payload":{"executionId":"3","success":true,"isManual":false,"workflowId":"yIL719IyREOoIwrM","workflowName":"SIGELED-CHAT-ADMIN"}}
{"__type":"$$EventMessageConfirm","confirm":"7ec7b9bb-03dd-41db-84f7-6b87bb49b60c","ts":"2025-12-05T00:41:17.367-05:00","source":{"id":"0","name":"eventBus"}}
